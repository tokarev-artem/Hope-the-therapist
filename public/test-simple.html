<!DOCTYPE html>
<html>
<head>
    <title>Simple User Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a1a; 
            color: white; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            background: #333; 
        }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background: #45a049; }
        #log { 
            background: #000; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            max-height: 300px; 
            overflow-y: auto; 
            margin-top: 20px; 
        }
    </style>
</head>
<body>
    <h1>Simple User Integration Test</h1>
    
    <div id="status" class="status">Connecting...</div>
    
    <button onclick="createTestUser()">Create Test User</button>
    <button onclick="startTestSession()">Start Session</button>
    <button onclick="endTestSession()">End Session</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="log"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUserId = null;
        let currentSessionId = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'status') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Socket event listeners
        socket.on('connect', () => {
            log('✅ Connected to server');
            updateStatus('Connected to server', 'success');
        });
        
        socket.on('disconnect', () => {
            log('❌ Disconnected from server');
            updateStatus('Disconnected from server', 'error');
        });
        
        socket.on('userCreated', (data) => {
            log(`User creation response: ${JSON.stringify(data)}`);
            if (data.success) {
                currentUserId = data.userId;
                updateStatus(`User created: ${data.userId.substring(0, 8)}...`, 'success');
            } else {
                updateStatus(`User creation failed: ${data.error}`, 'error');
            }
        });
        
        socket.on('sessionStarted', (data) => {
            log(`Session start response: ${JSON.stringify(data)}`);
            if (data.success) {
                currentSessionId = data.sessionId;
                updateStatus(`Session started: ${data.sessionId.substring(0, 8)}...`, 'success');
            } else {
                updateStatus(`Session start failed: ${data.error}`, 'error');
            }
        });
        
        socket.on('sessionCompleted', (data) => {
            log(`Session completion response: ${JSON.stringify(data)}`);
            if (data.success) {
                currentSessionId = null;
                updateStatus(`Session completed: ${data.summary}`, 'success');
            } else {
                updateStatus(`Session completion failed: ${data.error}`, 'error');
            }
        });
        
        // Test functions
        function createTestUser() {
            const userId = 'test-user-' + Date.now();
            const userName = prompt('Enter your name (optional):') || null;
            
            log(`Creating user: ${userId} (${userName || 'anonymous'})`);
            
            socket.emit('createUser', {
                userId: userId,
                userName: userName,
                isAnonymous: !userName
            });
        }
        
        function startTestSession() {
            if (!currentUserId) {
                alert('Please create a user first');
                return;
            }
            
            log(`Starting session for user: ${currentUserId}`);
            
            socket.emit('startTherapySession', {
                userId: currentUserId,
                initialEmotionalState: {
                    initialMood: 5,
                    stressLevel: 6,
                    anxietyLevel: 4,
                    dominantEmotions: ['curious', 'hopeful']
                }
            });
        }
        
        function endTestSession() {
            if (!currentSessionId) {
                alert('No active session to end');
                return;
            }
            
            log(`Ending session: ${currentSessionId}`);
            
            socket.emit('completeTherapySession', {
                sessionId: currentSessionId,
                userId: currentUserId,
                transcript: 'This is a test conversation transcript. User discussed feeling stressed about work and learned some breathing techniques.',
                finalEmotionalState: {
                    finalMood: 7,
                    stressLevel: 3,
                    anxietyLevel: 2,
                    calmingEffectiveness: 8
                },
                sessionMetrics: {
                    duration: 300, // 5 minutes
                    sessionQuality: 8,
                    engagementLevel: 9,
                    responseTime: 250,
                    interruptionCount: 0,
                    silenceDuration: 15
                },
                userConsent: true
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Auto-log connection status
        log('🚀 Page loaded, connecting to server...');
    </script>
</body>
</html>