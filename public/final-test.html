<!DOCTYPE html>
<html>
<head>
    <title>Final POC Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a1a; 
            color: white; 
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            background: #333; 
            border-left: 4px solid #64b5f6;
        }
        .success { background: #2d5a2d; border-left-color: #4caf50; }
        .error { background: #5a2d2d; border-left-color: #f44336; }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        #log { 
            background: #000; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: monospace; 
            max-height: 400px; 
            overflow-y: auto; 
            margin-top: 20px; 
            font-size: 14px;
        }
        .log-entry { margin-bottom: 8px; }
        .log-success { color: #4caf50; }
        .log-error { color: #f44336; }
        .log-info { color: #64b5f6; }
    </style>
</head>
<body>
    <h1>🎯 Final POC Test - Therapeutic Wave Interface</h1>
    
    <div id="status" class="status">
        <strong>Status:</strong> <span id="status-text">Initializing...</span>
    </div>
    
    <div>
        <h3>Test Flow:</h3>
        <button id="test-user" onclick="testUserCreation()">1. Test User Creation</button>
        <button id="test-session" onclick="testSession()" disabled>2. Test Session Flow</button>
        <button id="check-db" onclick="checkDatabase()">3. Check Database</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="log"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let testUserId = null;
        let testSessionId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<strong>[${time}]</strong> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'status') {
            const statusText = document.getElementById('status-text');
            const statusDiv = document.getElementById('status');
            statusText.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Socket event listeners
        socket.on('connect', () => {
            log('✅ Connected to server', 'success');
            updateStatus('Connected to server', 'success');
        });
        
        socket.on('disconnect', () => {
            log('❌ Disconnected from server', 'error');
            updateStatus('Disconnected from server', 'error');
        });
        
        socket.on('userCreated', (data) => {
            log(`User creation response: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
            if (data.success) {
                testUserId = data.userId;
                document.getElementById('test-session').disabled = false;
                updateStatus(`User created: ${data.userId.substring(0, 8)}...`, 'success');
            }
        });
        
        socket.on('sessionStarted', (data) => {
            log(`Session start response: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
            if (data.success) {
                testSessionId = data.sessionId;
                updateStatus(`Session active: ${data.sessionId.substring(0, 8)}...`, 'success');
                
                // Auto-complete session after 3 seconds
                setTimeout(() => {
                    completeTestSession();
                }, 3000);
            }
        });
        
        socket.on('sessionCompleted', (data) => {
            log(`Session completion response: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
            if (data.success) {
                testSessionId = null;
                updateStatus(`Session completed: ${data.summary}`, 'success');
                log(`📊 Session Summary: ${data.summary}`, 'success');
            }
        });
        
        // Test functions
        function testUserCreation() {
            const userId = 'test-user-' + Date.now();
            const userName = 'Test User POC';
            
            log(`🧪 Creating test user: ${userId} (${userName})`, 'info');
            
            socket.emit('createUser', {
                userId: userId,
                userName: userName,
                isAnonymous: false
            });
        }
        
        function testSession() {
            if (!testUserId) {
                alert('Please create a user first');
                return;
            }
            
            log(`🎙️ Starting test session for user: ${testUserId}`, 'info');
            
            socket.emit('startTherapySession', {
                userId: testUserId,
                initialEmotionalState: {
                    initialMood: 4,
                    stressLevel: 7,
                    anxietyLevel: 6,
                    dominantEmotions: ['anxious', 'stressed']
                }
            });
        }
        
        function completeTestSession() {
            if (!testSessionId) {
                log('❌ No active session to complete', 'error');
                return;
            }
            
            const testTranscript = \`User: Hello, I've been feeling really stressed about work lately. The deadlines are overwhelming and I can't seem to catch up.
Assistant: I understand that work stress can feel overwhelming. It sounds like you're dealing with a lot of pressure right now. Can you tell me more about what specifically is causing the most stress?
User: It's the constant deadlines and feeling like I'm never caught up. I barely have time to breathe between tasks.
Assistant: That sounds exhausting. Let's try some breathing exercises together. Take a deep breath in for 4 counts... hold for 4... and exhale for 4. How does that feel?
User: That actually helped a bit. I feel slightly calmer now.
Assistant: I'm glad the breathing exercise was helpful. Remember, you can use this technique whenever you feel overwhelmed. You're doing great by taking time to address your stress.\`;
            
            log(`⏹️ Completing test session with transcript (${testTranscript.length} chars)`, 'info');
            
            socket.emit('completeTherapySession', {
                sessionId: testSessionId,
                userId: testUserId,
                transcript: testTranscript,
                finalEmotionalState: {
                    initialMood: 4,
                    finalMood: 7,
                    stressLevel: 3,
                    anxietyLevel: 2,
                    calmingEffectiveness: 8
                },
                sessionMetrics: {
                    duration: 180, // 3 minutes
                    sessionQuality: 9,
                    engagementLevel: 8,
                    responseTime: 200,
                    interruptionCount: 0,
                    silenceDuration: 10,
                    voiceStressIndicators: {
                        averagePitch: 180,
                        pitchVariation: 40,
                        speakingRate: 140,
                        pauseFrequency: 0.2,
                        volumeConsistency: 0.9
                    }
                },
                userConsent: true
            });
        }
        
        function checkDatabase() {
            log('🔍 Checking database status...', 'info');
            log('📋 Expected data in DynamoDB:', 'info');
            log('  • therapeutic-wave-users-dev: Should have test user record', 'info');
            log('  • therapeutic-wave-sessions-dev: Should have session with transcript and summary', 'info');
            log('  • Check AWS Console or run: aws dynamodb scan --table-name therapeutic-wave-users-dev', 'info');
            updateStatus('Check server logs and AWS Console for database records', 'success');
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Auto-start when connected
        socket.on('connect', () => {
            setTimeout(() => {
                log('🚀 Ready for testing! Click "1. Test User Creation" to start', 'success');
            }, 1000);
        });
    </script>
</body>
</html>